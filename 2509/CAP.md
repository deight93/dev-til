# CAP 정리 (Brewer’s Theorem)

> **정의 한 줄**: 네트워크 **분할(Partition)** 상황에서 **일관성(Consistency: 선형화)** 과 **가용성(Availability)** 을 **동시에 완벽 보장할 수 없습니다**. 분산 시스템에서는 **분할 내성(P)** 을 전제로 두며, 분할이 발생하면 **C 또는 A 중 하나를 선택**해야 합니다.

---

## 왜 중요한가

* 장애·네트워크 이슈가 발생했을 때 **멈출지(CP)**, **틀릴 수 있음을 감수하고 계속 갈지(AP)** 를 **의식적으로 결정**할 기준이 됩니다.
* 멀티 리전/멀티 AZ 운영에서 **아키텍처 트레이드오프(일관성↔가용성)** 를 문서화하고 합의하는 데 필수입니다.

---

## 핵심 개념/정의

* **P(Partition tolerance)**: 노드 간 통신 손실/고지연이 있어도 시스템 설계가 이를 **견디는 성질**입니다. 인터넷/클라우드에서는 사실상 **항상 요구**됩니다.
* **C(Consistency)**: 모든 읽기/쓰기가 **단일 복제본처럼 보이는 강한 일관성**, 즉 **선형화(Linearizability)** 입니다.
* **A(Availability)**: 장애 없는 노드에 도달한 **모든 요청이 유한 시간 내 정상 응답**을 돌려줍니다(오류 없이).

> **정리의 결론**: **분할이 실제로 발생하는 순간**에는 **C 또는 A 중 하나를 포기**해야 합니다.
>
> * **CP**: 일관성 우선(분할 시 일부/전체 요청을 차단하거나 실패로 응답).
> * **AP**: 가용성 우선(분할 시에도 응답은 하되, **일시적 불일치**를 허용).

---

## 대표 시스템 성향(경향)

* **CP 성향**: etcd, ZooKeeper, Consul(Raft), CockroachDB, Google Spanner(전역 합의).
* **AP 성향**: Dynamo 계열, Riak, Cassandra(기본은 AP 경향이지만 **튜너블 일관성** 지원).
* **MongoDB**: 다수 합의(w: majority) 설정 시 **CP에 가까운 동작**(분할 시 쓰기 차단 가능).

> 참고: **R+W>N**(쿼럼 공식)은 **튜너블 일관성**의 이야기이며 CAP 자체의 정의는 아닙니다. 다만 실무에서 **C↔A 슬라이더**를 구현하는 실전 수단으로 함께 고려합니다.

---

## 설계 결정 가이드

* **CP를 택해야 하는 경우**

    * 송금/결제/주문·재고 등 **강한 불변식**이 핵심(중복 결제·이중 소모 금지).
    * **리더 선출 / 분산 락 / 메타데이터 일관성**이 매우 중요(etcd/ZK/Consul).
    * 정확한 순서/원자성(로그 순서, 카운터, 교차 파티션 트랜잭션)이 요구됨.
* **AP를 택해도 되는 경우**

    * 피드/추천/로그 수집/텔레메트리처럼 **일시적 불일치 허용**, 지연과 가용성 우선.
    * 오프라인-퍼스트/엣지 환경: 나중에 **머지 규칙(CRDT/도메인 규칙)** 으로 수렴.
    * 글로벌 분산에서 **사용자 가까운 응답**이 비즈니스에 더 중요할 때.
* **혼합 전략**

    * **소스 오브 트루스는 CP**(합의 저장소), **읽기 경로는 AP**(캐시·머티리얼라이즈드 뷰).
    * **CQRS + 이벤트 소싱**: 커맨드(쓰기)는 강C, 쿼리(읽기)는 AP 허용.
    * 튜너블 일관성: 중요 요청만 쿼럼(R/W 조합), 일반 요청은 근사 읽기.

---


## 요약

* CAP은 **분할 발생 시 C↔A 강제 선택**이라는 **경영·설계 의사결정 프레임**입니다.
* **CP**는 정합성 우선(차단 감수), **AP**는 가용성/지연 우선(충돌 해결 필요)입니다.
* 실무에서는 **도메인 불변식/사용자 경험/SLO**를 기준으로 시스템별 선택을 **문서화**하고, **혼합 전략**과 **카오스 테스트**로 검증하셔야 합니다.
